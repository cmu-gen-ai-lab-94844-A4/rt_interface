<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Generation and Annotation Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="data:;base64,=">

    <style>
       @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap');
       body {
           font-family: 'Open Sans', sans-serif;
           font-weight: 500;
           font-size: 16px;
           line-height: 1.5;
           color: #333333;
           background-color: #f8f9fa;
       }
       .content {
           margin-left: 260px; /* Same width as the sidebar */
           padding: 15px;
       }
    </style>

</head>
<body>
    {% extends 'base.html' %}

    {% block content %}

    <!-- Sidebar -->
    <div class="sidebar">
        <h2 style='color: white; padding-left:15px;'>Resources</h2>
        <!-- Add your sidebar links here, if needed -->
    </div>

    <div class="content">
        <h1>Image Generation and Captioning</h1>
        <div id="chat-window">
            <aside>
                <div class="card">
                    <div class="card-body">
                        <div id="messages" style="height: 300px; overflow-y: scroll; margin-bottom: 10px; background-color: #eafaf1;">
                            <!-- Messages and AI responses will appear here -->
                        </div>

                        <div class="input-group">
                            <input type="text" id="user_message" size="150" class="form-control" placeholder="Enter your prompt here...">
                            <button id="sendBtn" class="btn btn-primary">Generate Image</button>
                        </div>

                        <!-- Download History -->
                        <div class="mt-3">
                            <button class="btn btn-secondary" onclick="downloadChatHistory()">Download Chat History (JSON)</button>
                        </div>

                        <!-- Share and Flagging Buttons -->
                        <div class="mt-3">
                            <button class="btn btn-warning" onclick="shareToTeamPrompts()">Share Prompt to Team Feed</button>
                            <button class="btn btn-info" onclick="shareToTeamResponses()">Share Response to Team Feed</button>
                            <button class="btn btn-secondary" onclick="sharePromptToPublicFeed()">Share Prompt to Public Feed</button>
                            <button class="btn btn-success" onclick="shareToPublicResponses()">Share Response to Public Feed</button>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        const chatHistory = [];

        async function send_message() {
            const input = document.getElementById('user_message');
            const prompt = input.value.trim();
            if (!prompt) return;

            input.value = '';
            renderUserPromptMessage(prompt);

            try {
                const response = await fetch('/api/generate_image', {  // Adjust this URL according to your backend setup
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                const imageUrl = data.image_url;
                const caption = data.caption;

                renderAIResponse(imageUrl, caption);

                chatHistory.push({ prompt, imageUrl, caption });
            } catch (error) {
                console.error('Error generating image:', error);
            }
        }

        function renderUserPromptMessage(prompt) {
            const messages = document.getElementById('messages');
            messages.innerHTML += `<div class="alert alert-primary"><b>Prompt:</b> ${prompt}</div>`;
        }

        function renderAIResponse(imageUrl, caption) {
            const messages = document.getElementById('messages');
            const responseHTML = `
                <div class="alert alert-info">
                    <b>Generated Image:</b>
                    <br><img src="${imageUrl}" alt="Generated Image" style="max-width: 100%; height: auto;">
                    <br><b>Caption:</b> ${caption}
                </div>
            `;
            messages.innerHTML += responseHTML;
            messages.scrollTop = messages.scrollHeight;  // Scroll to latest message
        }

        function shareToTeamPrompts() {
            const prompt = document.getElementById('user_message').value.trim();
            if (!prompt) return alert('No prompt to share!');
            // Implement your fetch request here...
        }

        function shareToTeamResponses() {
            const response = document.querySelector('.alert-info').textContent.trim();
            if (!response) return alert('No response to share!');
            // Implement your fetch request here...
        }

        function sharePromptToPublicFeed() {
            const prompt = document.getElementById('user_message').value.trim();
            if (!prompt) return alert('No prompt to share!');
            // Implement your fetch request here...
        }

        function shareToPublicResponses() {
            const response = document.querySelector('.alert-info').textContent.trim();
            if (!response) return alert('No response to share!');
            // Implement your fetch request here...
        }

        function downloadChatHistory() {
            const blob = new Blob([JSON.stringify(chatHistory, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'chat_history.json';
            a.click();

            URL.revokeObjectURL(url);
        }

        document.getElementById('sendBtn').addEventListener('click', send_message);
    </script>

    {% endblock %}
</body>
</html>
